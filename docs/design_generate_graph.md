# generate_graph.js 詳細設計書

## 概要
Gistからデータを取得し、残りデータ通信量のグラフを生成するためのスクリプト。  
HTML形式でチャートを生成し、GitHub Actionsでの実行時には残りデータ量を環境変数として出力。

## 主な依存関係と環境
- Node.js 実行環境  
- fs, chart.js/auto, node-fetch, path, url  
- 必要な環境変数:  
  - GIST_USER  
  - GIST_ID  
  - GITHUB_ACTIONS (GitHub Actions実行時のみ)  
  - GITHUB_OUTPUT (GitHub Actions実行時のみ)  

## 処理フロー

### ディレクトリパスの設定
- ESモジュール形式で実行されるため、`__dirname`を`fileURLToPath`と`dirname`を使用して手動設定

### Gistからのデータ取得
- 目的: 環境変数で指定されたGistから残りデータ通信量の履歴を取得  
- 処理:  
  1. 環境変数からGistのURLを構築  
  2. node-fetchを使用してGistの生データをリクエスト  
  3. レスポンスをJSONとしてパース  
  4. データ形式の検証 (配列であることを確認)

### GitHub Actions対応
- 目的: CI/CD環境での実行時に最新のデータ値を出力変数として設定  
- 処理:  
  1. `GITHUB_ACTIONS`環境変数の有無を確認  
  2. 最新のデータエントリを取得し、値を小数点1桁に整形  
  3. GITHUB_OUTPUTファイルに値を追記  

### グラフデータの準備
- 目的: 取得したデータからChart.jsで使用するデータ構造を作成  
- 処理:  
  1. 日付ラベルの配列を生成  
  2. 残りデータ量の値の配列を生成  

### HTML生成
- 目的: Chart.jsを使用したインタラクティブなグラフをHTMLとして生成  
- 処理:  
  1. HTMLテンプレートを作成  
  2. Chart.jsのCDNを参照  
  3. グラフ設定 (線グラフ、軸ラベル、タイトル等)  
  4. 準備したデータを埋め込み  

### ファイル出力
- 目的: 生成したHTMLを`docs/index.html`に保存  
- 処理:  
  1. docsディレクトリが存在しない場合は作成  
  2. HTMLコンテンツをファイルに書き込み  

## エラー処理
- try-catchで全体を囲み、エラー発生時は:  
  1. エラーメッセージとスタックトレースをコンソールに出力  
  2. プロセスを終了コード1で終了  

## 実行方法
スクリプトは即時実行関数 (IIFE) で囲まれており、`node generate_graph.js`で実行可能。  
必要な環境変数が設定されていることが前提。

## 考慮点
- グラフのスタイリングやオプションはChart.jsの仕様に依存  
- 入力データは日付と残りデータ量のペアを含む配列形式であること  
- docsディレクトリにindex.htmlを出力するため、GitHubページとして公開可能