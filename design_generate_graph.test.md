# generate_graph.js テスト設計書

## 概要
このドキュメントでは、`generate_graph.js`に対するJestを使用したユニットテストの設計について詳述します。
各テストケースでは、関数の正常動作、エラー処理、境界値条件、およびエッジケースをカバーします。

---

## テスト仕様ID一覧
- TS-01: filterHourlyData 関数のテスト
  - TC-01-01: 基本的なフィルタリング
  - TC-01-02: 日付の変更があるケース
  - TC-01-03: 空の配列
- TS-02: getTimezoneInfo 関数のテスト
  - TC-02-01: デフォルトのタイムゾーン
  - TC-02-02: 数値オフセットのタイムゾーン
  - TC-02-03: 負の数値オフセットのタイムゾーン
  - TC-02-04: 名前付きタイムゾーン
  - TC-02-05: マッピングにない名前付きタイムゾーン
- TS-03: formatDate 関数のテスト
  - TC-03-01: 基本的な日付フォーマット
  - TC-03-02: 異なるタイムゾーンでのフォーマット
- TS-04: formatDateForInput 関数のテスト
  - TC-04-01: 基本的な日付フォーマット
  - TC-04-02: 異なるタイムゾーンでのフォーマット
  - TC-04-03: 年月日時分のパディング
- TS-05: prepareChartData 関数のテスト
  - TC-05-01: 基本的なデータ準備
  - TC-05-02: 空のデータ配列
  - TC-05-03: 異なる最大値でのY軸設定
  - TC-05-04: 表示範囲外に大きな値がある場合のY軸設定
  - TC-05-05: グラフ初期終了日時が月末であることの検証
- TS-06: calculateYAxisRange 関数のテスト
  - TC-06-01: 最大値が50GB以下の場合
  - TC-06-02: 最大値が100GB以下の場合
  - TC-06-03: 最大値が150GB以下の場合
  - TC-06-04: 最大値が上限を超える場合
- TS-07: fetchDataFromGist 関数のテスト
  - TC-07-01: 正常なレスポンス
  - TC-07-02: HTTPエラー
  - TC-07-03: 無効なJSONレスポンス
- TS-08: processGitHubActions 関数のテスト
  - TC-08-01: GitHub Actions環境での処理
  - TC-08-02: GitHub Actions環境でない場合
- TS-09: generateAndSaveHtml 関数のテスト
  - TC-09-01: HTMLファイルの生成と保存
  - TC-09-02: HTMLコンテンツの内容検証
- TS-10: fetchAndProcessData 関数のテスト
  - TC-10-01: 正常処理のフロー
  - TC-10-02: エラー処理

---

## テスト対象の関数
- `filterHourlyData`
- `getTimezoneInfo`
- `formatDate`
- `formatDateForInput`
- `prepareChartData`
- `calculateYAxisRange`
- `fetchDataFromGist`（モック必要）
- `processGitHubActions`
- `generateAndSaveHtml`（部分モック必要）
- `fetchAndProcessData`（統合テスト）

## テストケース詳細

### TS-01: filterHourlyData 関数のテスト

#### TC-01-01: 基本的なフィルタリング
- **目的**: データが1時間ごとに正しくフィルタリングされることを確認する
- **前提条件**: 時間の異なるデータポイントの配列がある
- **入力**: 
  ```javascript
  [
    { date: '2023-01-01T00:00:00Z', remainingData: '100' },
    { date: '2023-01-01T00:30:00Z', remainingData: '90' },
    { date: '2023-01-01T01:00:00Z', remainingData: '80' }
  ]
  ```
- **期待される結果**: 
  ```javascript
  [
    { date: '2023-01-01T00:00:00Z', remainingData: '100' },
    { date: '2023-01-01T01:00:00Z', remainingData: '80' }
  ]
  ```

#### TC-01-02: 日付の変更があるケース
- **目的**: 日付が変わる場合も正しくフィルタリングされることを確認する
- **前提条件**: 日付をまたぐデータポイントの配列がある
- **入力**: 
  ```javascript
  [
    { date: '2023-01-01T23:30:00Z', remainingData: '50' },
    { date: '2023-01-02T00:00:00Z', remainingData: '45' },
    { date: '2023-01-02T00:30:00Z', remainingData: '40' }
  ]
  ```
- **期待される結果**: 
  ```javascript
  [
    { date: '2023-01-01T23:30:00Z', remainingData: '50' },
    { date: '2023-01-02T00:00:00Z', remainingData: '45' }
  ]
  ```

#### TC-01-03: 空の配列
- **目的**: 空の配列を処理できることを確認する
- **前提条件**: 空の配列
- **入力**: `[]`
- **期待される結果**: `[]`

### TS-02: getTimezoneInfo 関数のテスト

#### TC-02-01: デフォルトのタイムゾーン
- **目的**: 環境変数が設定されていない場合のデフォルト値を確認する
- **前提条件**: `process.env.UTC_OFFSET`が未設定
- **入力**: なし（環境変数依存）
- **期待される結果**: `{ timezone: 'UTC', timezoneDisplay: 'UTC+0' }`

#### TC-02-02: 数値オフセットのタイムゾーン
- **目的**: 数値オフセットが正しく解析されることを確認する
- **前提条件**: `process.env.UTC_OFFSET = '+9'`
- **入力**: なし（環境変数依存）
- **期待される結果**: `{ timezone: 'Etc/GMT-9', timezoneDisplay: 'UTC+9' }`

#### TC-02-03: 負の数値オフセットのタイムゾーン
- **目的**: 負の数値オフセットが正しく解析されることを確認する
- **前提条件**: `process.env.UTC_OFFSET = '-5'`
- **入力**: なし（環境変数依存）
- **期待される結果**: `{ timezone: 'Etc/GMT+5', timezoneDisplay: 'UTC-5' }`

#### TC-02-04: 名前付きタイムゾーン
- **目的**: 名前付きタイムゾーンが正しく解析されることを確認する
- **前提条件**: `process.env.UTC_OFFSET = 'Asia/Tokyo'`
- **入力**: なし（環境変数依存）
- **期待される結果**: `{ timezone: 'Asia/Tokyo', timezoneDisplay: 'JST (UTC+9)' }`

#### TC-02-05: マッピングにない名前付きタイムゾーン
- **目的**: マッピングにない名前付きタイムゾーンがそのまま使用されることを確認する
- **前提条件**: `process.env.UTC_OFFSET = 'America/Chicago'`
- **入力**: なし（環境変数依存）
- **期待される結果**: `{ timezone: 'America/Chicago', timezoneDisplay: 'America/Chicago' }`

### TS-03: formatDate 関数のテスト

#### TC-03-01: 基本的な日付フォーマット
- **目的**: 日付が正しくフォーマットされることを確認する
- **前提条件**: 特定の日付文字列とタイムゾーン
- **入力**: `'2023-01-01T12:30:00Z'`, `'UTC'`
- **期待される結果**: 
  - 日本語ロケールでの月/日 時:分形式（例：`'1/1 12:30'`）

#### TC-03-02: 異なるタイムゾーンでのフォーマット
- **目的**: タイムゾーンの違いによる日付表示の変化を確認する
- **前提条件**: 特定の日付文字列と異なるタイムゾーン
- **入力**: `'2023-01-01T00:00:00Z'`, `'Asia/Tokyo'`
- **期待される結果**: 
  - 東京時間での表示（例：`'1/1 09:00'`）

### TS-04: formatDateForInput 関数のテスト

#### TC-04-01: 基本的な日付フォーマット
- **目的**: 日付が HTML datetime-local 入力用にフォーマットされることを確認する
- **前提条件**: 特定の日付オブジェクトとタイムゾーン
- **入力**: `new Date('2023-01-01T12:30:00Z')`, `'UTC'`
- **期待される結果**: `'2023-01-01T12:30'`

#### TC-04-02: 異なるタイムゾーンでのフォーマット
- **目的**: タイムゾーンの違いによる日付フォーマットの変化を確認する
- **前提条件**: 特定の日付オブジェクトと異なるタイムゾーン
- **入力**: `new Date('2023-01-01T00:00:00Z')`, `'Asia/Tokyo'`
- **期待される結果**: `'2023-01-01T09:00'`

#### TC-04-03: 年月日時分のパディング
- **目的**: 数値が適切にゼロ埋めされることを確認する
- **前提条件**: 1桁の月、日、時、分を含む日付
- **入力**: `new Date('2023-02-03T04:05:00Z')`, `'UTC'`
- **期待される結果**: `'2023-02-03T04:05'`

### TS-05: prepareChartData 関数のテスト

#### TC-05-01: 基本的なデータ準備
- **目的**: チャートデータが正しく準備されることを確認する
- **前提条件**: フィルタリングされたデータの配列とタイムゾーン
- **入力**:
  ```javascript
  [
    { date: '2023-01-01T00:00:00Z', remainingData: '10.5' },
    { date: '2023-01-02T00:00:00Z', remainingData: '9.8' }
  ], 'UTC'
  ```
- **期待される結果**:
  ```javascript
  {
    chartData: [
      { x: 1672531200000, y: 10.5 },
      { x: 1672617600000, y: 9.8 }
    ],
    dateInfo: {
      firstDate: new Date('2023-01-01T00:00:00Z'),
      lastDate: new Date('2023-01-02T00:00:00Z'),
      currentDate: /* 現在の日時 */,
      firstDateFormatted: '2023-01-01T00:00',
      lastDateFormatted: '2023-01-02T00:00',
      currentDateFormatted: /* フォーマットされた現在日時 */
    },
    axisSettings: {
      yAxisMin: 0,
      yAxisMax: 50 // デフォルト値（※表示範囲内の最大値で決定すること）
    }
  }
  ```

#### TC-05-02: 空のデータ配列
- **目的**: 空のデータ配列の処理を確認する
- **前提条件**: 空の配列
- **入力**: `[]`, `'UTC'`
- **期待される結果**: エラーまたは適切な初期値

#### TC-05-03: 異なる最大値でのY軸設定
- **目的**: 異なる最大値に基づくY軸設定を確認する
- **前提条件**: 高い値を持つデータの配列
- **入力**:
  ```javascript
  [
    { date: '2023-01-01T00:00:00Z', remainingData: '120.5' },
    { date: '2023-01-02T00:00:00Z', remainingData: '150.8' }
  ], 'UTC'
  ```
- **期待される結果**: axisSettings内のyAxisMaxが適切に調整される（例：150または200）

#### TC-05-04: 表示範囲外に大きな値がある場合のY軸設定
- **目的**: 全期間の最大値が表示範囲外にあっても、表示範囲内の最大値でY軸が決まることを確認する
- **前提条件**: 表示範囲外に120GB、表示範囲内に100GBのデータがある
- **入力**:
  - 全データ: 120GB, 100GB, 80GB
  - 表示範囲: 100GB, 80GB
- **期待される結果**: axisSettings内のyAxisMaxは100となる

#### TC-05-05: グラフ初期終了日時が月末であることの検証
- **目的**: prepareChartDataのdateInfo.lastDateが月末になっていることを確認する
- **前提条件**: 現在日時が2025-07-19、データが7月中に存在
- **入力**:
  ```javascript
  [
    { date: '2025-07-01T00:00:00Z', remainingData: '10.0' },
    { date: '2025-07-19T00:00:00Z', remainingData: '8.0' }
  ], 'UTC'
  ```
- **期待される結果**:
  - dateInfo.lastDateが2025-07-31 23:59:59.999（UTC）である
  - dateInfo.lastDateFormattedが'2025-07-31T23:59'である

### TS-06: calculateYAxisRange 関数のテスト

#### TC-06-01: 最大値が50GB以下の場合
- **目的**: 最大値が50GB以下の場合はY軸最大値が50GBになることを確認する
- **前提条件**: 最大値が30
- **入力**: `30`
- **期待される結果**: `{ yAxisMin: 0, yAxisMax: 50 }`

#### TC-06-02: 最大値が100GB以下の場合
- **目的**: 最大値が100GB以下の場合のレンジを確認する
- **前提条件**: 最大値が75
- **入力**: `75`
- **期待される結果**: `{ yAxisMin: 0, yAxisMax: 100 }`

#### TC-06-03: 最大値が150GB以下の場合
- **目的**: 最大値が150GB以下の場合のレンジを確認する
- **前提条件**: 最大値が120
- **入力**: `120`
- **期待される結果**: `{ yAxisMin: 0, yAxisMax: 150 }`

#### TC-06-04: 最大値が上限を超える場合
- **目的**: 最大値がMAX_LIMIT以上の場合のレンジを確認する
- **前提条件**: 最大値が600
- **入力**: `600`
- **期待される結果**: `{ yAxisMin: 0, yAxisMax: 500 }`

### TS-07: fetchDataFromGist 関数のテスト

#### TC-07-01: 正常なレスポンス
- **目的**: 正常なレスポンスの処理を確認する
- **前提条件**: fetch関数のモック化
- **入力**: 有効なGist URL
- **モックレスポンス**: 
  ```json
  [
    { "date": "2023-01-01T00:00:00Z", "remainingData": "10.5" }
  ]
  ```
- **期待される結果**: モックデータと同じ値が返される

#### TC-07-02: HTTPエラー
- **目的**: HTTPエラーの処理を確認する
- **前提条件**: fetch関数のモック化（エラーを返す）
- **入力**: 有効なGist URL
- **モックレスポンス**: `{ ok: false, status: 404 }`
- **期待される結果**: エラーがスローされる

#### TC-07-03: 無効なJSONレスポンス
- **目的**: 無効なJSON形式の処理を確認する
- **前提条件**: fetch関数のモック化（無効なJSONを返す）
- **入力**: 有効なGist URL
- **モックレスポンス**: 非配列値（例：`{}`）
- **期待される結果**: エラーがスローされる

### TS-08: processGitHubActions 関数のテスト

#### TC-08-01: GitHub Actions環境での処理
- **目的**: GitHub Actions環境での処理を確認する
- **前提条件**: process.env.GITHUB_ACTIONSをtrue、process.env.GITHUB_OUTPUTを設定、fsモジュールのモック化
- **入力**: `[{ date: '2023-01-01T00:00:00Z', remainingData: '10.5' }]`
- **期待される結果**: fs.appendFileSyncが正しいパラメータで呼び出される

#### TC-08-02: GitHub Actions環境でない場合
- **目的**: GitHub Actions環境でない場合の処理を確認する
- **前提条件**: process.env.GITHUB_ACTIONSを未設定
- **入力**: `[{ date: '2023-01-01T00:00:00Z', remainingData: '10.5' }]`
- **期待される結果**: fs.appendFileSyncが呼び出されない

### TS-09: generateAndSaveHtml 関数のテスト

#### TC-09-01: HTMLファイルの生成と保存
- **目的**: HTMLファイルが生成・保存されることを確認する
- **前提条件**: fs.mkdirSyncとfs.writeFileSyncのモック化
- **入力**: 有効なチャートデータ、日付情報など
- **期待される結果**: fs.mkdirSyncとfs.writeFileSyncが正しいパラメータで呼び出される

#### TC-09-02: HTMLコンテンツの内容検証
- **目的**: 生成されるHTMLコンテンツが正しい内容を含むことを確認する
- **前提条件**: fs.writeFileSyncのモック化とキャプチャ
- **入力**: 特定のテストデータ
- **期待される結果**: HTML内に正しいデータやスクリプトが含まれている

### TS-10: fetchAndProcessData 関数のテスト

#### TC-10-01: 正常処理のフロー
- **目的**: fetchAndProcessDataの全体的な処理フローを確認する
- **前提条件**: 各依存関数のモック化（fetchDataFromGist, filterHourlyData, generateAndSaveHtmlなど）
- **入力**: なし（環境変数に依存）
- **期待される結果**: 各モック関数が正しい順序と引数で呼び出される

#### TC-10-02: エラー処理
- **目的**: エラー発生時の動作を確認する
- **前提条件**: fetchDataFromGistがエラーをスローするようにモック化
- **入力**: なし（環境変数に依存）
- **期待される結果**: コンソールにエラーが出力され、process.exitが呼び出される

## モック化の方針

### ファイルシステム操作のモック
- `fs.mkdirSync`
- `fs.writeFileSync`
- `fs.appendFileSync`
- Jestの`__mocks__/fs.js`を利用

### 外部APIのモック
- `fetch` (node-fetch)
- Jestの`jest.mock('node-fetch')`を利用

### 環境変数のモック
- `process.env`の各プロパティを一時的に設定
- 各テスト後に元の値に戻すか削除

### 日時関連のモック
- `new Date()`
- Jestの`jest.spyOn(global, 'Date')`または`MockDate`ライブラリを利用

## テスト実行方針

1. 各関数の単体テストを独立させる
2. テスト間の相互干渉を避けるため、テスト前後で環境をリセットする
3. モックオブジェクトを使用して外部依存性を制御
4. 統合テストでは全体的な流れを検証
5. テストカバレッジが高くなるように設計（目標: 80%以上）

## 注意点

- テストでは実際のAPIコールやファイル操作を行わないようにする
- 環境変数に依存するテストでは、テスト前後で環境を適切に管理する
- 日時に依存するテストでは固定の日時を使用する
- エラーケースも確実にテストする